<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Login Page</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
	<style>
		.search-section{
			margin-right: 10px;
		}
		.page-link{
			cursor: pointer;
		}
		#errorMessage{
			color: #8b0000;
		}
	</style>
</head>
<body>
		
	<nav class="navbar navbar-expand-lg navbar-light bg-light">
		<div class="container-fluid">

		  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTogglerDemo01" aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		  </button>

		  <div class="collapse navbar-collapse" id="navbarTogglerDemo01">

			<label class="navbar-brand">Product Details</label>	

			<ul class="navbar-nav me-auto mb-2 mb-lg-0">
				<li class="nav-item">
					<span class="d-flex mr-3">
						<button name="Add Product" type="button" class="btn btn-outline-primary"
						id="addProduct">Add Product</button>
					</span>
				</li>
			</ul>

			<li class="d-flex mr-3">
				<span class="d-flex mr-3 nav-link">
					<span id="errorMessage"></span>
				</span>
			</li>

			<form class="d-flex mr-3 search-section">
				<input class="form-control me-2" type="search" placeholder="Search" 
				aria-label="Search" id="searchProductName">
				<button class="btn btn-outline-success" type="button" id="searchProductButton">Search</button>
			</form>		
			
			<span class="d-flex">
			  <button name="logout" type="button" class="btn btn-outline-warning">Logout</button>
			</span>

		  </div>
		</div>
	</nav>

	<!-- Product Details table Start-->
	<section class="vh-75">
		<div class="container-fluid py-2 h-75">
			<table class="table table-hover table-bordered">
				<thead>
					<th>ID</th>
					<th>Name</th>
					<th>Price</th>
					<th>Description</th>
					<th>Created By</th>
					<th>Actions</th>
				</thead>

				<tbody>
					<!-- <tr>
						<td>1</td>
						<td>Car</td>
						<td>100</td>
						<td>Demo car description.</td>
						<td>User 1</td>
						<td>

							<button class="btn btn-sm btn-primary" data-bs-toggle="modal" 
							data-bs-target="#productUpdate">Update</button>

							<button class="btn btn-sm btn-danger" data-bs-toggle="modal"
							data-bs-target="#productDelete">Delete</button>

						</td>
					</tr> -->

				</tbody>
			</table>
		</div>
	</section>

	<!-- Product Details Table End -->
	<div class="container-fluid">
		<nav aria-label="Page navigation example">
			<ul class="pagination justify-content-end">
				
				<!-- <li class="page-item"><span class="page-link" href="#">1</span></li> -->
				
			</ul>
		</nav>
	</div>

	<!-- Add Product Details Modal Start-->	
	<div class="modal fade" id="productAdd" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="productAddModalLabel" aria-hidden="true">
		<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
			<h5 class="modal-title" id="productAddModalLabel">Add New Product Details</h5>
			<button type="button" class="btn-close closeAddProductModal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				
				<div class="form-floating mb-4">
				<input type="text" name="newProductName" id="newProductName" class="form-control" 
					placeholder="Product Name" required/>
					<label class="form-label" for="newProductName">Product Name</label>
				</div>
		
				<div class="form-floating mb-4">
					<input type="number" name="newProductPrice" id="newProductPrice" class="form-control" 
					placeholder="Product Price" required/>
					<label class="form-label" for="newProductPrice">Product Price</label>
				</div>

				<div class="form-floating mb-4">
					<input type="text" name="newProductDescription" id="newProductDescription" class="form-control" 
					placeholder="Product Description" required/>
					<label class="form-label" for="newProductDescription">Product Description</label>
				</div>
				
				<ul id="addNewProductMessage" class="mb-2 p-0 list-group list-group-flush"></ul>
				
			</div>
			<div class="modal-footer">
			<button type="button" class="btn btn-secondary closeAddProductModal">Cancel</button>
			<button name="addNewProduct" id="addNewProduct" type="button" class="btn btn-success">Submit</button>
			</div>
		</div>
		</div>
	</div>
	<!-- Add Product Details Modal End -->

	<!-- Update Product Details Modal Start-->	
	<div class="modal fade" id="productUpdate" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="productUpdateModalLabel" aria-hidden="true">
		<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
			<h5 class="modal-title" id="productUpdateModalLabel">Update Product Details</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				
				<div class="form-floating mb-4">
				<input type="text" id="productName" class="form-control" 
					placeholder="Product Name" required/>
					<label class="form-label" for="productName">Product Name</label>
				</div>
		
				<div class="form-floating mb-4">
					<input type="number" id="productPrice" class="form-control" 
					placeholder="Product Price" required/>
					<label class="form-label" for="productPrice">Product Price</label>
				</div>

				<div class="form-floating mb-4">
					<input type="text" id="productDescription" class="form-control" 
					placeholder="Product Description" required/>
					<label class="form-label" for="productDescription">Product Description</label>
				</div>
				
			</div>
			<div class="modal-footer">
			<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
			<button name="updateProduct" type="button" class="btn btn-success">Submit</button>
			</div>
		</div>
		</div>
	</div>
	<!-- Update Product Details Modal End -->

	<!-- Delete Procudt Modal Start-->	
	<div class="modal fade" id="productDelete" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="productDeleteModalLabel" aria-hidden="true">
		<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
			<h5 class="modal-title" id="productDeleteModalLabel">Delete Product Details</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<h6>Are you sure you want to delete this product?</h6>
			</div>
			<div class="modal-footer">
			<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
			<button name="deleteProduct" type="button" class="btn btn-success">Confirm</button>
			</div>
		</div>
		</div>
	</div>
	<!-- Delete Product Modal End -->

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"
		integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

	<script>
		const userID = localStorage.getItem("userID")
		const authorizationToken = localStorage.getItem("authorizationToken")

		const showAllProducts = (page,limit) => {

				$.ajax({
					url: `http://localhost:8000/products?page=${page}&limit=${limit}`,
					headers: {
						"Content-Type": "application/json",
						"Authorization": `Bearer ${authorizationToken}`
					},
					method: "GET",
					dataType: "json",
					success: (response) => {

						const totalProducts = response.totalProducts
						const products = response.products
						numberOfPages = Math.ceil(totalProducts / limit)
						window.page = page

						$(".pagination").html("")

						for(let i=1; i<= numberOfPages; i++){
							$(".pagination").append(`<li class="page-item" data-page-no="${i}"
							onclick="showAllProducts(${i},${limit})">
							<span class="page-link">${i}</span></li>`)
						}

						$("tbody").html("")

						products.forEach(element => {
							$("tbody").append(`<tr>
								<td>${element.product_id}</td>
								<td>${element.product_name}</td>
								<td>${element.product_price}</td>
								<td>${element.product_description}</td>
								<td>${element.user_name}</td>
								<td>
									<button class="btn btn-sm btn-primary" data-bs-toggle="modal" 
									data-bs-target="#productUpdate" data-product-id=${element.product_id}>Update</button>
									<button class="btn btn-sm btn-danger" data-bs-toggle="modal" 
									data-bs-target="#productDelete" data-product-id=${element.product_id}>Delete</button>
								</td>
								</tr>`)
						});

					},
					error: (error) => {
						console.log(error)
					}
				})
			}

		$(document).ready(async () => {

			const emailRegex = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;

			const limit = 10;
			window.page = 1;

			let numberOfPages = 0

			if (userID && authorizationToken) {
				$.ajax({

					url: "http://localhost:8000/check-token",
					headers: {
						"Content-Type": "application/json",
						"Authorization": `Bearer ${authorizationToken}`
					},
					method: "GET",
					dataType: "json",
					success: (response) => {

						console.log("You are authorized.")
					},
					error: (error)  => {

						if(error.status == 401 || error.status == 403){
							// window.location.href = "login.html"
						}
					}
				})
			}
			
			
			
			await showAllProducts(window.page,limit)

			// let products = []

			// async function showAllProducts(page,limit){
			// 	const response = await fetch(`http://localhost:8000/products?page=${page}&limit=${limit}`)
			// 	const data  = await response.json()
			// 	return data
			// }

			// showAllProducts(page,limit).then((productData) => {
			// 	const totalProducts = productData.totalProducts
			// 	products = productData.products
			// 	console.log(products)
			// 	numberOfPages = Math.round(totalProducts / limit)

			// 	for(let i=1; i<= numberOfPages; i++){
			// 		$(".pagination").append(`<li class="page-item" data-page-no="${i}"><span class="page-link">${i}</span></li>`)
			// 	}

			// 	products.forEach(element => {
			// 		$("tbody").append(`<tr>
			// 			<td>${element.product_id}</td>
			// 			<td>${element.product_name}</td>
			// 			<td>${element.product_price}</td>
			// 			<td>${element.product_description}</td>
			// 			<td>${element.user_name}</td>
			// 			<td>
			// 				<button class="btn btn-sm btn-primary" data-bs-toggle="modal" 
			// 				data-bs-target="#productUpdate" data-product-id=${element.product_id}>Update</button>
			// 				<button class="btn btn-sm btn-danger" data-bs-toggle="modal" 
			// 				data-bs-target="#productDelete" data-product-id=${element.product_id}>Delete</button>
			// 			</td>
			// 			</tr>`)
			// 	});

			// 	$(document).on("click", ".page-item", () => {
			// 		let pageNo = $(this).data("page-no")
			// 		console.log(pageNo)
			// 		// showAllProducts(pageNo)
			// 	})
			// })
			
			// Add new product start

			$("#addProduct").on("click", () => {
				$("#addNewProductMessage").html("")
				$("#productAdd").modal("show")
			})

			$(".closeAddProductModal").on("click" ,() => {
				$("#addNewProductMessage").html("")
				$("#productAdd").modal("hide")
			})
			
			$("#addNewProduct").on("click", () => {

				const newProductName = $("#newProductName").val()
				const newProductPrice = $("#newProductPrice").val()
				const newProductDescription = $("#newProductDescription").val()
				const errorMessage = []
				$("#addNewProductMessage").html("")

				if(!newProductName || !newProductPrice || !newProductDescription){
					errorMessage.push("Please fill up all the details")
				}
				console.log(errorMessage)

				errorMessage.forEach((item,index) => {
					$("#addNewProductMessage").append(`<li class="list-group-item list-group-item-danger text-center">${item}</li>`)
				})

				if(!errorMessage.length){

					$("#addNewProductMessage").html("")
					
					const newProductData = JSON.stringify({
						productName: newProductName,
						productPrice: newProductPrice,
						productDescription: newProductDescription,
						userID
					})

					$.ajax({
						url: "http://localhost:8000/add-product",
						headers: {
							"Content-Type": "application/json",
							"Authorization": `Bearer ${authorizationToken}`
						},
						method: "POST",
						dataType: "json",
						data: newProductData,
						success: (response) => {
							$("#newProductName").val("")
							$("#newProductPrice").val("")
							$("#newProductDescription").val("")

							$("#addNewProductMessage").append(`<li class="list-group-item list-group-item-success text-center">${response.message}</li>`)

							setTimeout(() => {
								$("#addNewProductMessage").html("")
								$("#productAdd").modal("hide")
								showAllProducts(window.page,limit)
							}, 1000)
						},
						error: (error) => {
							$("#newProductName").val("")
							$("#newProductPrice").val("")
							$("#newProductDescription").val("")
							
							$("#addNewProductMessage").append(`<li class="list-group-item list-group-item-danger text-center">${error.responseJSON.message}</li>`)

							setTimeout(() => {
								$("#addNewProductMessage").html("")
								$("#productAdd").modal("hide")
								window.location.href = "login.html"
							}, 2000)
						}
					})

				}
			})

			// add new product end

			// search product start

			$("#searchProductButton").on("click" , () => {

				const productName = $("#searchProductName").val()

				$.ajax({
					url: `http://localhost:8000/search-product?productName=${productName}`,
					headers: {						
						"Authorization": `Bearer ${authorizationToken}`
					},
					method: "GET",
					success: (response) => {

						if(response.data.length){

							products = response.data
							$("tbody").html("")

							products.forEach(element => {
								$("tbody").append(`<tr>
									<td>${element.product_id}</td>
									<td>${element.product_name}</td>
									<td>${element.product_price}</td>
									<td>${element.product_description}</td>
									<td>${element.user_name}</td>
									<td>
										<button class="btn btn-sm btn-primary" data-bs-toggle="modal" 
										data-bs-target="#productUpdate" data-product-id=${element.product_id}>Update</button>
										<button class="btn btn-sm btn-danger" data-bs-toggle="modal" 
										data-bs-target="#productDelete" data-product-id=${element.product_id}>Delete</button>
									</td>
									</tr>`)
							});
						}

					},
					error: (error) => {
						if(error.status == 404){
							$("tbody").html("")
							$("#errorMessage").html("No such product found").show().fadeOut(5000)
							setTimeout(() => {
								showAllProducts(window.page,limit)
							}, 3000);
						}
					}

				})

			})

			// search product end

		})
	</script>
</body>
</html>