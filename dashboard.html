<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Login Page</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
	<style>
		.search-section{
			margin-right: 10px;
		}
		.page-link{
			cursor: pointer;
		}
		#errorMessage{
			color: #8b0000;
		}
	</style>
</head>
<body>
		
	<nav class="navbar navbar-expand-lg navbar-light bg-light">
		<div class="container-fluid">

		  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTogglerDemo01" aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		  </button>

		  <div class="collapse navbar-collapse" id="navbarTogglerDemo01">

			<label class="navbar-brand">Product Details</label>	

			<ul class="navbar-nav me-auto mb-2 mb-lg-0">
				<li class="nav-item">
					<span class="d-flex mr-3">
						<button name="Add Product" type="button" class="btn btn-outline-primary"
						id="addProduct">Add Product</button>
					</span>
				</li>
			</ul>

			<li class="d-flex mr-3">
				<span class="d-flex mr-3 nav-link">
					<span id="errorMessage"></span>
				</span>
			</li>

			<form class="d-flex mr-3 search-section">
				<input class="form-control me-2" type="search" placeholder="Search" 
				aria-label="Search" id="searchProductName">
				<button class="btn btn-outline-success" type="button" id="searchProductButton"
				onclick="searchProductFunction()">Search</button>
			</form>		
			
			<span class="d-flex">
			  <button name="logoutButton" type="button" class="btn btn-outline-warning"
			  id="logoutButton">
			  <span class="spinner-grow spinner-grow-sm d-none" role="status" aria-hidden="true"></span>
			  <span class="logoutButtonText">Logout</span>
			</button>
			</span>

		  </div>
		</div>
	</nav>

	<!-- Product Details table Start-->
	<section class="vh-75">
		<div class="container-fluid py-2 h-75">
			<table class="table table-hover table-bordered">
				<thead>
					<th>ID</th>
					<th>Name</th>
					<th>Price</th>
					<th>Description</th>
					<th>Created By</th>
					<th>Actions</th>
				</thead>

				<tbody>
					<!-- <tr>
						<td>1</td>
						<td>Car</td>
						<td>100</td>
						<td>Demo car description.</td>
						<td>User 1</td>
						<td>

							<button class="btn btn-sm btn-primary" data-bs-toggle="modal" 
							data-bs-target="#productUpdate">Update</button>

							<button class="btn btn-sm btn-danger" data-bs-toggle="modal"
							data-bs-target="#productDelete">Delete</button>

						</td>
					</tr> -->

				</tbody>
			</table>
		</div>
	</section>

	<!-- Product Details Table End -->
	<div class="container-fluid">
		<nav aria-label="Page navigation example">
			<ul class="pagination justify-content-end">
				
				<!-- <li class="page-item"><span class="page-link" href="#">1</span></li> -->
				
			</ul>
		</nav>
	</div>

	<!-- Add Product Details Modal Start-->	
	<div class="modal fade" id="addNewProductModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="addNewProductModalLabel" aria-hidden="true">
		<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
			<h5 class="modal-title" id="addNewProductModalLabel">Add New Product Details</h5>
			<button type="button" class="btn-close closeAddProductModal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				
				<div class="form-floating mb-4">
				<input type="text" name="newProductName" id="newProductName" class="form-control" 
					placeholder="Product Name" required/>
					<label class="form-label" for="newProductName">Product Name</label>
				</div>
		
				<div class="form-floating mb-4">
					<input type="number" name="newProductPrice" id="newProductPrice" class="form-control" 
					placeholder="Product Price" required/>
					<label class="form-label" for="newProductPrice">Product Price</label>
				</div>

				<div class="form-floating mb-4">
					<input type="text" name="newProductDescription" id="newProductDescription" class="form-control" 
					placeholder="Product Description" required/>
					<label class="form-label" for="newProductDescription">Product Description</label>
				</div>
				
				<ul id="addNewProductMessage" class="mb-2 p-0 list-group list-group-flush"></ul>
				
			</div>
			<div class="modal-footer">
			<button type="button" class="btn btn-secondary closeAddProductModal">Cancel</button>
			<button name="addNewProductButton" id="addNewProductButton" type="button" class="btn btn-success">Submit</button>
			</div>
		</div>
		</div>
	</div>
	<!-- Add Product Details Modal End -->

	<!-- Update Product Details Modal Start-->	
	<div class="modal fade" id="updateProductModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="updateProductModalLabel" aria-hidden="true">
		<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
			<h5 class="modal-title" id="updateProductModalLabel">Update Product Details</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				
				<input type="hidden" name="updateProductID" id="updateProductID" class="form-control" 
					required/>

				<input type="hidden" name="updateProductByUser" id="updateProductByUser" class="form-control" 
					required/>

				<div class="form-floating mb-4">
				<input type="text" name="updateProductName" id="updateProductName" class="form-control" 
					placeholder="Product Name" required/>
					<label class="form-label" for="updateProductName">Product Name</label>
				</div>
		
				<div class="form-floating mb-4">
					<input type="number" name="updateProductPrice" id="updateProductPrice" class="form-control" 
					placeholder="Product Price" required/>
					<label class="form-label" for="updateProductPrice">Product Price</label>
				</div>

				<div class="form-floating mb-4">
					<input type="text" name="updateProductDescription" id="updateProductDescription" class="form-control" 
					placeholder="Product Description" required/>
					<label class="form-label" for="updateProductDescription">Product Description</label>
				</div>
				
				<ul id="updateProductMessage" class="mb-2 p-0 list-group list-group-flush"></ul>

			</div>
			<div class="modal-footer">
			<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
			<button name="updateProductButton" type="button" class="btn btn-success"
			onclick="updadeProductFunction()">Submit</button>
			</div>
		</div>
		</div>
	</div>
	<!-- Update Product Details Modal End -->

	<!-- Delete Procudt Modal Start-->	
	<div class="modal fade" id="deleteProductModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="deleteProductModalLabel" aria-hidden="true">
		<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
			<h5 class="modal-title" id="deleteProductModalLabel">Delete Product</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<input type="hidden" name="deleteProductID" id="deleteProductID">
				<h6>Are you sure you want to delete this product?</h6>

				<ul id="deleteProductMessage" class="mb-2 p-0 list-group list-group-flush"></ul>
			</div>
			<div class="modal-footer">
			<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
			<button name="deleteProductButton" type="button" class="btn btn-danger"
			onclick="deleteProductFunction()">Confirm</button>
			</div>
		</div>
		</div>
	</div>
	<!-- Delete Product Modal End -->

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"
		integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

	<script>
		const userID = localStorage.getItem("userID")
		const authorizationToken = localStorage.getItem("authorizationToken")

		//show all product end
		
		const showAllProducts = (page,limit) => {

				$.ajax({
					url: `http://localhost:8000/products?page=${page}&limit=${limit}`,
					headers: {
						"Content-Type": "application/json",
						"Authorization": `Bearer ${authorizationToken}`
					},
					method: "GET",
					dataType: "json",
					success: (response) => {

						const totalProducts = response.totalProducts
						window.products = response.products
						numberOfPages = Math.ceil(totalProducts / limit)
						window.page = page

						$(".pagination").html("")

						for(let i=1; i<= numberOfPages; i++){
							$(".pagination").append(`<li class="page-item"
							onclick="showAllProducts(${i},${limit})">
							<span class="page-link">${i}</span></li>`)
						}

						$("tbody").html("")

						window.products.forEach(element => {
							$("tbody").append(`<tr>
								<td>${element.product_id}</td>
								<td>${element.product_name}</td>
								<td>${element.product_price}</td>
								<td>${element.product_description}</td>
								<td>${element.user_name}</td>
								<td>
									<button class="btn btn-sm btn-primary" 
									onclick="openUpdateProductModal(${element.product_id})">Update</button>
									<button class="btn btn-sm btn-danger"
									onclick="openDeleteProductModal(${element.product_id})">Delete</button>
								</td>
								</tr>`)
						});

					},
					error: (error) => {
						console.log(error)
					}
				})
			}

			// show all product end

			//open update product modal function start

			const openUpdateProductModal = async (productID) => {

				const productToUpdate = await window.products.filter((item) => {
					return item.product_id == productID
				})

				$("#updateProductID").val(`${productToUpdate[0].product_id}`)
				$("#updateProductName").val(`${productToUpdate[0].product_name}`)
				$("#updateProductPrice").val(`${productToUpdate[0].product_price}`)
				$("#updateProductDescription").val(`${productToUpdate[0].product_description}`)
				$("#updateProductByUser").val(`${userID}`)

				$("#updateProductModal").modal("show")

			}

			// open update product modal function end

			// update product function start

			const updadeProductFunction = () => {

				const updateProductID = $("#updateProductID").val()
				const updateProductName = $("#updateProductName").val()
				const updateProductPrice = $("#updateProductPrice").val()
				const updateProductDescription = $("#updateProductDescription").val()
				const updateProductByUser = $("#updateProductByUser").val()

				console.log(updateProductID)
				console.log(updateProductName)
				console.log(updateProductPrice)
				console.log(updateProductDescription)
				console.log(updateProductByUser)

				let updateProductErrorMessage = []

				$("#updateProductMessage").html("")

				if(!updateProductName || !updateProductPrice || !updateProductDescription){
					updateProductErrorMessage.push("Please fill up all the details")
				}
				console.log(updateProductErrorMessage)

				updateProductErrorMessage.forEach((item,index) => {
					$("#updateProductMessage").append(`<li class="list-group-item list-group-item-danger text-center">${item}</li>`)
				})

				if(!updateProductErrorMessage.length){

					$("#updateProductMessage").html("")
					
					const newProductData = JSON.stringify({
						productID: updateProductID,
						productName: updateProductName,
						productPrice: updateProductPrice,
						productDescription: updateProductDescription,
						userID
					})

					$.ajax({
						url: "http://localhost:8000/update-product",
						headers: {
							"Content-Type": "application/json",
							"Authorization": `Bearer ${authorizationToken}`
						},
						method: "PUT",
						dataType: "json",
						data: newProductData,
						success: (response) => {
							$("#updateProductID").val("")
							$("#updateProductName").val("")
							$("#updateProductPrice").val("")
							$("#updateProductDescription").val("")
							$("#updateProductByUser").val("")

							$("#updateProductMessage").append(`<li class="list-group-item list-group-item-success text-center">${response.message}</li>`)

							setTimeout(() => {
								$("#updateProductMessage").html("")
								$("#updateProductModal").modal("hide")
								showAllProducts(window.page,window.limit)
							}, 3000)
						},
						error: (error) => {
							$("#updateProductID").val("")
							$("#updateProductName").val("")
							$("#updateProductPrice").val("")
							$("#updateProductDescription").val("")
							$("#updateProductByUser").val("")
							
							$("#updateProductMessage").append(`<li class="list-group-item list-group-item-danger text-center">${error.responseJSON.message}</li>`)

							setTimeout(() => {
								$("#updateProductMessage").html("")
								$("#updateProductModal").modal("hide")
								showAllProducts(window.page,window.limit)
							}, 3000)
						}
					})

				}

			}

			// update product function end

			// search product start

			const searchProductFunction = () => {

				const productName = $("#searchProductName").val()

				if(productName){

					$.ajax({
						url: `http://localhost:8000/search-product?productName=${productName}`,
						headers: {						
							"Authorization": `Bearer ${authorizationToken}`
						},
						method: "GET",
						success: (response) => {

							if(response.data.length){

								window.products = response.data
								$("tbody").html("")

								window.products.forEach(element => {
									$("tbody").append(`<tr>
										<td>${element.product_id}</td>
										<td>${element.product_name}</td>
										<td>${element.product_price}</td>
										<td>${element.product_description}</td>
										<td>${element.user_name}</td>
										<td>
											<button class="btn btn-sm btn-primary"
											onclick="openUpdateProductModal(${element.product_id})">Update</button>
											<button class="btn btn-sm btn-danger"
											onclick="openDeleteProductModal(${element.product_id})">Delete</button>
										</td>
										</tr>`)
								});
							}

						},
						error: (error) => {
							if(error.status == 404){
								$("tbody").html("")
								$("#errorMessage").html("No such product found").show().fadeOut(5000)
								setTimeout(() => {
									showAllProducts(window.page,window.limit)
								}, 3000);
							}
						}

					})
				}
			}

			// search product end

			// open delete product modal start

			const openDeleteProductModal = (productID) => {console.log(productID)

				$("#deleteProductID").val(productID)

				$("#deleteProductModal").modal("show")
			}

			// open delete product modal end

			// delete product function start

			const deleteProductFunction = (productID) => {

				const deleteProductID = $("#deleteProductID").val()

				$.ajax({
					url: `http://localhost:8000/delete-product?productID=${deleteProductID}`,
					headers: {
						"Content-Type": "application/json",
						"Authorization": `Bearer ${authorizationToken}`
					},
					method: "DELETE",
					dataType: "json",
					success: (response) => {
						$("#deleteProductID").val("")

						$("#deleteProductMessage").append(`<li class="list-group-item list-group-item-success text-center">${response.message}</li>`)

						setTimeout(() => {
							$("#deleteProductMessage").html("")
							$("#deleteProductModal").modal("hide")
							showAllProducts(window.page,window.limit)
						}, 3000)
					},
					error: (error) => {
						$("#deleteProductID").val("")
						
						$("#deleteProductMessage").append(`<li class="list-group-item list-group-item-danger text-center">${error.responseJSON.message}</li>`)

						setTimeout(() => {
							$("#deleteProductMessage").html("")
							$("#deleteProductModal").modal("hide")
							showAllProducts(window.page,window.limit)
						}, 3000)
					}
				})

			}

			// delete product function end

		$(document).ready(async () => {

			const emailRegex = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;

			window.limit = 10;
			window.page = 1;

			let numberOfPages = 0

			if (userID && authorizationToken) {
				$.ajax({

					url: "http://localhost:8000/check-token",
					headers: {
						"Content-Type": "application/json",
						"Authorization": `Bearer ${authorizationToken}`
					},
					method: "GET",
					dataType: "json",
					success: (response) => {

						console.log("You are authorized.")
					},
					error: (error)  => {

						if(error.status == 401 || error.status == 403){
							// window.location.href = "login.html"
						}
					}
				})
			}
			
			
			
			await showAllProducts(window.page,window.limit)

			// let products = []

			// async function showAllProducts(page,limit){
			// 	const response = await fetch(`http://localhost:8000/products?page=${page}&limit=${limit}`)
			// 	const data  = await response.json()
			// 	return data
			// }

			// showAllProducts(page,limit).then((productData) => {
			// 	const totalProducts = productData.totalProducts
			// 	products = productData.products
			// 	console.log(products)
			// 	numberOfPages = Math.round(totalProducts / limit)

			// 	for(let i=1; i<= numberOfPages; i++){
			// 		$(".pagination").append(`<li class="page-item" data-page-no="${i}"><span class="page-link">${i}</span></li>`)
			// 	}

			// 	products.forEach(element => {
			// 		$("tbody").append(`<tr>
			// 			<td>${element.product_id}</td>
			// 			<td>${element.product_name}</td>
			// 			<td>${element.product_price}</td>
			// 			<td>${element.product_description}</td>
			// 			<td>${element.user_name}</td>
			// 			<td>
			// 				<button class="btn btn-sm btn-primary" data-bs-toggle="modal" 
			// 				data-bs-target="#productUpdate" data-product-id=${element.product_id}>Update</button>
			// 				<button class="btn btn-sm btn-danger" data-bs-toggle="modal" 
			// 				data-bs-target="#productDelete" data-product-id=${element.product_id}>Delete</button>
			// 			</td>
			// 			</tr>`)
			// 	});

			// 	$(document).on("click", ".page-item", () => {
			// 		let pageNo = $(this).data("page-no")
			// 		console.log(pageNo)
			// 		// showAllProducts(pageNo)
			// 	})
			// })
			
			// Add new product start

			$("#addProduct").on("click", () => {
				$("#addNewProductMessage").html("")
				$("#addNewProductModal").modal("show")
			})

			$(".closeAddProductModal").on("click" ,() => {
				$("#addNewProductMessage").html("")
				$("#addNewProductModal").modal("hide")
			})
			
			$("#addNewProductButton").on("click", () => {

				const newProductName = $("#newProductName").val()
				const newProductPrice = $("#newProductPrice").val()
				const newProductDescription = $("#newProductDescription").val()
				let errorMessage = []
				$("#addNewProductMessage").html("")

				if(!newProductName || !newProductPrice || !newProductDescription){
					errorMessage.push("Please fill up all the details")
				}
				console.log(errorMessage)

				errorMessage.forEach((item,index) => {
					$("#addNewProductMessage").append(`<li class="list-group-item list-group-item-danger text-center">${item}</li>`)
				})

				if(!errorMessage.length){

					$("#addNewProductMessage").html("")
					
					const newProductData = JSON.stringify({
						productName: newProductName,
						productPrice: newProductPrice,
						productDescription: newProductDescription,
						userID
					})

					$.ajax({
						url: "http://localhost:8000/add-product",
						headers: {
							"Content-Type": "application/json",
							"Authorization": `Bearer ${authorizationToken}`
						},
						method: "POST",
						dataType: "json",
						data: newProductData,
						success: (response) => {
							$("#newProductName").val("")
							$("#newProductPrice").val("")
							$("#newProductDescription").val("")

							$("#addNewProductMessage").append(`<li class="list-group-item list-group-item-success text-center">${response.message}</li>`)

							setTimeout(() => {
								$("#addNewProductMessage").html("")
								$("#addNewProductModal").modal("hide")
								showAllProducts(window.page,window.limit)
							}, 1000)
						},
						error: (error) => {
							$("#newProductName").val("")
							$("#newProductPrice").val("")
							$("#newProductDescription").val("")
							
							$("#addNewProductMessage").append(`<li class="list-group-item list-group-item-danger text-center">${error.responseJSON.message}</li>`)

							setTimeout(() => {
								$("#addNewProductMessage").html("")
								$("#addNewProductModal").modal("hide")
								window.location.href = "login.html"
							}, 2000)
						}
					})

				}
			})

			// add new product end

			// search product start

			$("#searchProductButton").on("click" , searchProductFunction())

			// search product end

			// logout function start	

			$("#logoutButton").on("click", async () => {

				await localStorage.removeItem("userID")
				await localStorage.removeItem("authorizationToken")

				$(".logoutButtonText").html("Loading...")
				$(".spinner-grow").removeClass("d-none")
				
				setTimeout(() => {
					window.location.href = "login.html"
				}, 2000);

			})

			// logout function end

		})
	</script>
</body>
</html>